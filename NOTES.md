# HACKING NOTES

開発時の思い出です。

- このアプリケーションの肝は、ショートカットキーを入力されると、その直前に入力されていたキー入力のうち繰り返されていたものを繰り返すというところにある。
  - キーロガー的な挙動と、キーの送出ができれば良い。
- rdev を利用して実装を開始した。
  - rdev を見なければ、開発を開始していなかっただろう。感謝。
- しかし、rdev の挙動では、いくつか、このアプリケーションを実現するにあたって実現不可能な挙動があった
  - OSごとの差異を隠蔽するようにしている結果、本来はOSXのAPIで実現可能な動作ができなくなっていた
  - 具体的には例えばキーショートカットが Ctrl-T となっている場合、その状態でキーを送出すると、Ctrlが押下された状態でキー入力したことになってしまうのだ。
    - これを治すためには、Control キーの keyrelease イベントを送出すれば良さそうに思うが、そうやってもコントロールキーが離れた状態にはならなかった
    - OSX では Modifier キーの押下状態は FlagChanged イベントで送出され、Control/Shift/Alt などの Modifier キーは keydown/keyup みたいな扱いになっていないっぽい気がする
  - つまりこのへんの挙動を完璧に管理するためには、OS 非依存の状態で実装をかけるのは無理だ。
  - よって、この段階で rdev をそのまま扱うのは諦める必要がある
    - coregraphics crate を直接使って、生っぽいAPIを叩く方が結局良いなという結論に至る。
  - FlagsChanged イベントを送出することで、Modifierキーの入力をクリアできた。
  - 次に、逆にモディファイヤーキーを入力しながら入力しているケースの再現だが、その際には CGEvent にモディファイヤを付属させられる。
    - 入力時点での Flags を保存しておいて、 `CGEventSetFlags` でFlags付与すれば良い。
- このアプリ自体が送出したキーイベントと、自動で入力されるキーイベントを見分けることも重要だ
  - マクロ機能で送出されたキーイベントが記録されるとわけわからんことになるので。。
  - `CGEventSetIntegerValueField` を使って、`CGEvent` にフラグを付与すればよろしい。
- Configuration file 機構を実装した
  - ショートカットキーをカスタマイズ可能とした。
  - `confy` create を採用した。
    - 設定ファイルの処理が簡単に行える
- github で公開。
  - github actions で、最低限、ビルドができることを確認するようにした。
- tauri 化を開始
  - SystemTray に表示する機能を実装した
  - cmd-tab でリストアップされてしまう。
    - [tauri-plugin-positioner](https://github.com/tauri-apps/tauri-plugin-positioner) を使えば良さそう
    - 消えたっぽい?
- アイコンの変更
  - DALL-E で作った適当なアイコンに差し替え
  - 後で、良いものがあれば差し替えたい
    - https://tauri.app/v1/guides/features/icons の手順でやれば差し替えられます
    -  `cd src-tauri && npm run icon path/to/icon.png`
- build
  - `cd src-tauri && npm run tauri build` でアプリケーションがビルドされる。
  - dmg ファイルが生成される。
- simplelog 使いにくいので、fern に変えようかなぁ。
  - fern のほうが柔軟に設定できそう
- ログをもう少し増やす。
  - デバッグしやすくする必要がありそう
  - ログレベルを設定ファイルでいじれるようにしておく
- minutus 使ってみるのも面白いかもしれない
  - mruby でハンドリング部分を書いて、カスタマイズできたら面白いかも
  - 一旦、ビルドが通らないので Pull-request を出した。
  - global 変数として `kCGEventKeyDown` とかを mruby の世界にわたす方法がまずわからない。謎。
- boajs という JS のランタイムを見つけたので検討してみよう。
  - pure rust で、EcmaScript を頑張って実装しているみたい
  - インターフェースが割りといい感じっぽい
  - 定数を js の世界にわたすのはできそう。
  - JS の世界から callback を呼ぶことにできるようにしたい
  - Event オブジェクトをオブジェクトとして扱えると良い
  - boajs で一通り実装できた。
  - とりあえず、JS で同等のコードが実装できた。
- `Key.A` みたいなキーコードを取れたほうが良さそう。
  - 入れた
- ダイナミックマクロの予測機能(現在は繰り返しの自動抽出のみが実装されている)
  - 実装できた。
- コア部分を分離させた
- 設定機能
  - ショートカットキーの設定機能
    - based on tauri?
  - ログレベルを設定で変えられるようにする
  - 一通り実装済み。設定をリロードする機能もついた。
- boajs でJSを実行するのではなく、tauri で実行したらどうだろうか?
  - key event をアプリに送るべきかどうかをコールバックの返り値で見てるので、怖い。
- ユーザーがJSで拡張できるようにしたい
- ドキュメントの充実があとは必要。

- 残タスク
  - test 用のフレームワークを作りたい。
  - dynamicmacro.js に対するテストを書けるようにしたい。
  - プラグイン削除機能はほしいかもしれない。
